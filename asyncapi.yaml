asyncapi: 3.1.0
info:
  title: crawlbot2 Protocol
  version: 1.1.0
  description: |
    Comprehensive specification for the crawlbot2 system, covering external WebSocket 
    communication with the DCSS game server and internal mpsc channel routing.
    This version includes the full producer-consumer pairs for internal channels.

channels:
  gameServer:
    address: 'ws://127.0.0.1:8080/socket'
    messages:
      # Outgoing
      Register: { $ref: '#/components/messages/Register' }
      Login: { $ref: '#/components/messages/Login' }
      Play: { $ref: '#/components/messages/Play' }
      InputText: { $ref: '#/components/messages/InputText' }
      InputKey: { $ref: '#/components/messages/InputKey' }
      Pong: { $ref: '#/components/messages/Pong' }
      # Incoming
      GameEvent: { $ref: '#/components/messages/GameEvent' }
      Ping: { $ref: '#/components/messages/Ping' }

  internalProcessor:
    address: 'mpsc://tx_receiver'
    description: Channel combining external server events with local REPL commands.
    messages:
      ProcessMessage: { $ref: '#/components/messages/ProcessMessage' }

  internalSender:
    address: 'mpsc://tx_sender'
    description: Channel for messages queued to be sent over the WebSocket.
    messages:
      WsMessage: { $ref: '#/components/messages/WsMessage' }

operations:
  receiveFromServer:
    description: External server events received via the WebSocket stream.
    action: receive
    channel: 
      $ref: '#/channels/gameServer'
    messages:
      - $ref: '#/channels/gameServer/messages/GameEvent'
      - $ref: '#/channels/gameServer/messages/Ping'

  sendToServer:
    description: Commands sent to the external game server.
    action: send
    channel: 
      $ref: '#/channels/gameServer'
    messages:
      - $ref: '#/channels/gameServer/messages/Register'
      - $ref: '#/channels/gameServer/messages/Login'
      - $ref: '#/channels/gameServer/messages/Play'
      - $ref: '#/channels/gameServer/messages/InputText'
      - $ref: '#/channels/gameServer/messages/InputKey'
      - $ref: '#/channels/gameServer/messages/Pong'

  queueForProcessing:
    description: spawn_receiver or run_repl sending events to the internal processor.
    action: send
    channel:
      $ref: '#/channels/internalProcessor'
    messages:
      - $ref: '#/channels/internalProcessor/messages/ProcessMessage'

  processEvents:
    description: spawn_processor receiving from rx_receiver for decision making.
    action: receive
    channel:
      $ref: '#/channels/internalProcessor'
    messages:
      - $ref: '#/channels/internalProcessor/messages/ProcessMessage'

  routeToSender:
    description: spawn_processor pushing commands to the outgoing message queue.
    action: send
    channel:
      $ref: '#/channels/internalSender'
    messages:
      - $ref: '#/channels/internalSender/messages/WsMessage'

  consumeFromSender:
    description: spawn_sender receiving from rx_sender to transmit over WebSocket.
    action: receive
    channel:
      $ref: '#/channels/internalSender'
    messages:
      - $ref: '#/channels/internalSender/messages/WsMessage'

components:
  messages:
    # --- Outgoing ---
    Register:
      title: User Registration
      summary: Register a new user account on the DCSS server.
      payload:
        type: object
        properties:
          msg: { const: 'register' }
          username: { type: string }
          password: { type: string }
          email: { type: string }
        required: [msg, username, password]

    Login:
      title: User Login
      summary: Authenticate an existing user.
      payload:
        type: object
        properties:
          msg: { const: 'login' }
          username: { type: string }
          password: { type: string }
        required: [msg, username, password]

    Play:
      title: Start Game
      summary: Request to start a new game instance.
      payload:
        type: object
        properties:
          msg: { const: 'play' }
          game_id: { type: string, enum: ['dcss-web-trunk', 'seeded-web-trunk'] }
        required: [msg, game_id]

    InputText:
      title: Text Input
      summary: Send a text string (e.g., character name, command) to the game.
      payload:
        type: object
        properties:
          msg: { const: 'input' }
          text: { type: string }
        required: [msg, text]

    InputKey:
      title: Key Input
      summary: Send a specific keycode (e.g., Enter, Esc) to the game.
      payload:
        type: object
        properties:
          msg: { const: 'key' }
          keycode: { type: integer }
        required: [msg, keycode]

    Pong:
      title: Pong Heartbeat
      summary: Response to a server-initiated ping to keep the connection alive.
      payload:
        type: object
        properties:
          msg: { const: 'pong' }
        required: [msg]

    # --- Incoming ---
    Ping:
      title: Ping Heartbeat
      summary: Server-initiated ping to check client liveness.
      payload:
        type: object
        properties:
          msg: { const: 'ping' }
        required: [msg]

    GameEvent:
      title: Game State Event
      summary: Any event sent by the server describing the state of the game (map, UI, player, etc.).
      payload:
        $ref: '#/components/schemas/GameMessage'

    # --- Internal ---
    ProcessMessage:
      title: Process Event
      summary: Internal message wrapping either a server event or a REPL command for processing.
      description: Discriminated union of Server events and REPL inputs.
      payload:
        oneOf:
          - $ref: '#/components/schemas/GameMessage'
          - type: object
            properties:
              repl: { type: string }
            required: [repl]

    WsMessage:
      title: WebSocket Outgoing Message
      summary: A raw message string ready to be transmitted over the WebSocket.
      description: Raw message string to be sent via the WebSocket.
      payload:
        type: string

  schemas:
    GameMessage:
      type: object
      properties:
        msg: 
          type: string
          enum:
            - 'html'
            - 'lobby_clear'
            - 'lobby_complete'
            - 'login_success'
            - 'ui-push'
            - 'ui-pop'
            - 'set_game_links'
            - 'game_client'
            - 'game_started'
            - 'chat'
            - 'version'
            - 'options'
            - 'layout'
            - 'ui-state-sync'
            - 'ui-state'
            - 'ui_state'
            - 'player'
            - 'update_spectators'
            - 'text_cursor'
            - 'map'
        title: { type: string }
        cells: 
          type: array
          items: { $ref: '#/components/schemas/Cell' }
      required: [msg]

    Cell:
      type: object
      properties:
        x: { type: integer }
        y: { type: integer }
        g: { type: string, description: 'The character/glyph for this cell' }
